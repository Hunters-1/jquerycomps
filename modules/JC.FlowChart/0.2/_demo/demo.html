<!doctype html>
<html>
    <head>
        <meta charset=utf-8 />
        <title>Open JQuery Components Library - suches</title>
        <style>
            body{
                margin: 20px 40px;
            }

            dt { font-weight: bold; margin: 10px auto; }
            dd { line-height: 24px; }

            .jtk-dialog-overlay { position: absolute; }

            .jtk-dialog-content input[type="text"], .jtk-dialog-content select { width: 100%; height: 30px; line-height: 30px; border: 1px solid #CCC; color: #333; font-size: 14px; } 

            .jtk-dialog-content input { text-indent: 10px; margin-right: -1px; }

            .jtk-dialog-content a { text-decoration: none; }

            .jtk-dialog-content .addBtn { color: green; }

            .jtk-dialog-content .delBtn { color: red; }

            .jtk-dialog-content tr { height: 34px; line-height: 34px; }

            .jtk-dialog-content th { width: 20%; }

            .jtk-dialog-content td { width: 80%; padding: 3px 0; }

            .jtk-dialog-content table { width: 360px; }

            .jtk-dialog-content td a { margin: 0 10px; font-weight: normal; }

            .jtk-dialog-content .condition-table { width: 630px; }

            .condition-table th { width: 14%; }

            .condition-table td { width: 86%; }

            .dialog-lb { width: 30%; display: inline-block; }

            .dialog-ct { width: 70%; display: inline-block; }

            .expBlock { float: left; position: relative; margin: 0 10px 6px 0; height: 40px; line-height: 40px; padding: 0 26px 0 6px; border: 1px solid #ccc; background-color: #E8E8EA; }

            .expBlock a { position: absolute; top: 0; right: 0; height: 100%; width: 26px; margin: 0 !important; font-family: Helvetica; text-align: center; color: #999; }

            .expBlock select { margin-right: 5px; }

            .exp-green { width:300px; background: #DBFFA7; }

            .exp-green2 { width:120px; background: #DBFFA7; }

            .exp-blue { background: #D7EDFF; }

            .jtk-dialog-content .blue { color: rgb(65, 162, 242); }

            .jtk-dialog-content .errmsg { min-width: 1px; }
        </style>
        <link href='../../../../modules/JC.FlowChart/0.2/res/default/style.css' rel='stylesheet' />
        <link href='../../../../modules/JC.Valid/0.2//res/default/style.css' rel='stylesheet' />
    </head>    
    <body>
        <dl class="defdl">
            <dt>JC.FlowChart - 示例</dt>
            <dd>
                <p>
                    <button onclick="exportData();">导出数据</button>
                </p>
                <div style="width:100%">
                    <div class="js_compFlowChart" 
                        fc-node-function="nodeFunction"
                        fc-edge-function="edgeFunction"
                    >
                    </div>
                </div>
            </dd>
        </dl>
        <script type="jtk" class="dlg" id="fc-action-form">
            <form errorabort="true">
                <table>
                    <tr>
                        <th>节点名称：</th>
                        <td>
                            <input type="text" jtk-att="text" value="${text}" minlength="2" maxlength="20" reqmsg="节点名称" errmsg="至少输入2个字" emel="(table .errmsg"/>
                        </td>
                    </tr>
                    <tr>
                        <th>数据模型：</th>
                        <td>
                            <select jtk-att="mode" subdatatype="ucheck" ucheckCallback="selectCheck" ucheckmsg="请选择数据模型" emel="(table .errmsg" >
                                <option value="-1">请选择</option>
                                <option value="0">数据模型1</option>
                                <option value="1">数据模型2</option>
                                <option value="2">数据模型3</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th rowspan="2">操作人员：</th>
                        <td>
                            <label class="dialog-lb"><input class="js_changeIpt" type="radio" target="input.changeEl" value="0" jtk-att="operatorType" name="operatorType"/>指定人员</label>
                            <label class="dialog-lb"><input class="js_changeIpt" type="radio" target="select.changeEl" value="1" jtk-att="operatorType" name="operatorType" checked/>指定角色</label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input class="changeEl" type="text" jtk-att="operator" reqmsg="人员名称" emel="(table .errmsg" style="display:none;"/>
                            <select class="changeEl" jtk-att="role" subdatatype="ucheck" ucheckCallback="selectCheck" ucheckmsg="请选择角色" emel="(table .errmsg">
                                <option value="-1">请选择</option>
                                <option value="0">角色1</option>
                                <option value="1">角色2</option>
                                <option value="2">角色3</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <em class="errmsg"></em>
                        </td>
                    </tr>
                </table>
            </form>
        </script>

        <script type="jtk" class="dlg" id="fc-question-form">
            <form errorabort="true">
                <table class="condition-table">
                    <tr>
                        <th>节点名称：</th>
                        <td>
                            <input type="text" jtk-att="text" minlength="2" maxlength="20" reqmsg="节点名称" errmsg="至少输入2个字" emel="(table .errmsg"/>
                        </td>
                    </tr>
                    <tr>
                        <th>聚合条件：</th>
                        <td>
                            <a href="javascript:;" class="js_autoCommonModify addBtn" cmtemplate="#addTogether" cmitem="#expView" cmaction="add" cmappendtype="appendTo" cmtplfiltercallback="togetherFilter">添加条件</a>
                            <a href="javascript:;" class="js_autoCommonModify addBtn blue" cmtemplate="#addSymbol" cmitem="#expView" cmaction="add" cmappendtype="appendTo">添加符号</a>
                        </td>
                    </tr>
                    <tr>
                        <th></th>
                        <td>
                            <p id="expView">${condition}</p>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <em class="errmsg"></em>
                        </td>
                    </tr>
                </table>
            </form>
        </script>

        <script type="jtk" class="dlg" id="fc-edge-form">
            <form errorabort="true">
                <table class="condition-table">
                    <tr>
                        <th>条件描述：</th>
                        <td>
                            <input type="text" jtk-att="label" value="${text}" minlength="2" maxlength="20" reqmsg="条件描述" errmsg="至少输入2个字" emel="(table .errmsg"/>
                        </td>
                    </tr>
                    <tr>
                        <th>通过条件：</th>
                        <td>
                            <a href="javascript:;" class="js_autoCommonModify addBtn" cmtemplate="#addCondition" cmitem="#expView" cmaction="add" cmappendtype="appendTo" cmtplfiltercallback="conditionFilter">添加条件</a>
                            <a href="javascript:;" class="js_autoCommonModify addBtn blue" cmtemplate="#addSymbol" cmitem="#expView" cmaction="add" cmappendtype="appendTo">添加符号</a>
                        </td>
                    </tr>
                    <tr>
                        <th></th>
                        <td>
                            <p id="expView">${condition}</p>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <em class="errmsg"></em>
                        </td>
                    </tr>
                </table>
            </form>
        </script>

        <script type="jtk" class="dlg" id="fc-output-form">
            <form errorabort="true">
                <table>
                    <tr>
                        <th>节点名称：</th>
                        <td>
                            <input type="text" jtk-att="text" minlength="2" maxlength="20" reqmsg="节点名称" errmsg="至少输入2个字" emel="(table .errmsg"/>
                        </td>
                    </tr>
                </table>
            </form>
        </script>

        <script type="text/template" id="addCondition">
            <div class="expBlock exp-green" block-type="condition">
                <select class="js_modeDataSel" subdatatype="ucheck" ucheckCallback="selectCheck" ucheckmsg="请选择数据" emel="(table .errmsg" style="width: 40%;">
                    <option value="-1">请选择</option>
                    {0}
                </select><select class="js_modeSbl" style="width: 15%;">
                    <option value="eq_0">&lt;</option>
                    <option value="eq_1">&le;</option>
                    <option value="eq_2">=</option>
                    <option value="eq_3">&ge;</option>
                    <option value="eq_4">&gt;</option>
                    <option value="eq_5">&ne;</option>
                </select><span class="js_ctnView">{1}</span>
                <a href="javascript:;" class="js_autoCommonModify" cmtemplate="#addCondition" cmitem="(div" cmaction="del" >X</a>
            </div>
        </script>

        <script type="text/template" id="addTogether">
            <div class="expBlock exp-green2" block-type="together">
                <select class="js_modeSbl">
                    <option value="-1">请选择</option>
                    {0}
                </select>
                <a href="javascript:;" class="js_autoCommonModify" cmtemplate="#addCondition" cmitem="(div" cmaction="del" >X</a>
            </div>
        </script>

        <script type="text/template" id="addSymbol">
            <div class="expBlock exp-blue"  block-type="symbol">
                <select class="js_symbolSel">
                    <option value="sy_0">(</option>
                    <option value="sy_1">)</option>
                    <option value="sy_2">且</option>
                    <option value="sy_3">或</option>
                </select>
                <a href="javascript:;" class="js_autoCommonModify" cmtemplate="#addSymbol" cmitem="(div" cmaction="del">X</a>
            </div>
        </script>
        <script src="../../../../lib.js"></script>
        <script src="../../../../config.js"></script>
        <script>
            JC.debug = true;

            requirejs( [ 'JC.FlowChart0.2', 'Bizs.CommonModify', 'JC.Valid' ], function(){

                JDOC.on( 'change', '.js_changeIpt', function() {
                    var $this = $( this ),
                        target = $this.attr( 'target' );

                    $( '.changeEl' ).hide().filter( target ).show();
                } );

                JDOC.on( 'change', '.js_modeDataSel', function( e ) {
                    var $this = $( this ),
                        viewDom = $this.closest( 'div' ).find( '.js_ctnView' ),
                        value = $this.val(),
                        tpl;

                    if( value < 0 ) {
                        return;
                    }

                    $.get( 'fontend/getFileCnt.php?data='+$this.val(), function( result ) {
                        // result = JSON.parse( result );

                        if( result.errno == 0 ) {
                            viewDom.html( '' );

                            var data = result.data;
                            if( data.type == 0 ) {//input
                                tpl = '<input style="width: 35%;" reqmsg="请填写数据"/>';

                                viewDom.append( tpl );
                            } else {//select
                                var list = [],
                                    optionTpl = '<option value="{1}">{0}</option>';

                                $.each( data.data, function( i, item ) {
                                    list.push( JC.f.printf( optionTpl, item.name, item.value ) );
                                } );

                                tpl = '<select class="js_modeCntSel" style="width: 35%;" subdatatype="ucheck" ucheckCallback="selectCheck" ucheckmsg="请选择数据" emel="(table .errmsg"><option value="-1">请选择</option>{0}</select>';

                                viewDom.append( JC.f.printf( tpl, list.join( '' ) ) );
                            }
                        } else {
                            alert( result.errmsg );
                        }
                    } );
                } );
            });

            function exportData() {
                console.log( JSON.parse( JC.FlowChart.exportData( '.js_compFlowChart' ) ) );
            }

            function nodeFunction(type, data, callback, obj) {

                var tplId = 'dlgText',
                    togetherList = [],
                    title,
                    tmpId;

                switch( type ) {
                    case 'action': {
                        tmpId = 'fc-action-form';
                        title = '活动节点设置';
                        break;
                    }
                    case 'question': {
                        tmpId = 'fc-question-form';
                        title = '聚合节点设置';

                        if( obj.getTargetEdges ) {
                            window.linkEdgeList = [];
                            $.each( obj.getTargetEdges(), function( i, item ){
                                window.linkEdgeList.push( item.data );
                            } );

                            console.log( window.linkEdgeList );
                        }
                        break;
                    }
                    case 'output': {
                        tmpId = 'fc-output-form';
                        title = '结束节点设置';
                        break;
                    }
                }

                jsPlumbToolkit.Dialogs.show({
                    id: tmpId,
                    data: data,
                    title: title,
                    onOK: function (d) {
                        data.text = d.text;
                        d.togetherList = togetherList;
                        data.data = d;


                        if (data.text && data.text.length >= 2) {

                            if( !obj ) {
                                data.id = jsPlumbToolkitUtil.uuid();
                            }
                            callback(data);
                        } else {
                            alert(type + " 描述不得少于2个字!");
                        }
                    },
                    onMaybeClose: function() {
                        var viewBlock = $( '#expView' ),
                            conditionData,
                            type;

                        $.each( viewBlock.find( 'div.expBlock' ), function( i, item ) {
                            item = $( item );
                            type = item.attr( 'block-type' );

                            if( type == 'together' ) {
                                conditionData = {
                                    tvalue: item.find( '.js_modeSbl' ).val()
                                };
                            } else {
                                conditionData = {
                                    symbol: item.find( '.js_symbolSel' ).val()
                                }
                            }

                            togetherList.push( {
                                type: type,
                                data: conditionData
                            } );
                        } );

                        return JC.Valid.check( $( '.jtk-dialog-overlay form' ) );
                    }
                });

                if( data.togetherList.length > 0 ) {
                    var expBlock = $( '#expView' ),
                        togetherTpl = $( '#addTogether' ).html(),
                        symbolTpl = $( '#addSymbol' ).html(),
                        $together, $symbol, ctnTpl;

                    $.each( data.togetherList, function( i, item ){
                        if( item.type == 'together' ) {
                            var list = [],
                                optionTpl = '<option value="{1}">{0}</option>';

                            $.each( window.linkEdgeList, function( i, item ) {
                                list.push( JC.f.printf( optionTpl, item.label, item.id ) );
                            } );

                            $together = $( JC.f.printf( togetherTpl, list.join( '' ) ).replace( /[\s]{2,}/g, '' ) );

                            $together.find( '.js_modeSbl option[ value=' + item.data.tvalue + ' ]' ).attr( 'selected', true );

                            expBlock.append( $together );
                        } else {
                            $symbol = $( symbolTpl.replace( /[\s]{2,}/g, '' ) );

                            $symbol.find( '.js_symbolSel option[ value='+ item.data.symbol +' ]' ).attr( 'selected', true );

                            expBlock.append( $symbol );
                        }
                    });
                }

                $( '.js_changeIpt' ).filter( ':checked' ).change();
            }

            function edgeFunction( type, data, callback, obj ) {

                var modeCode = obj.source.data.data.mode,
                    conditionList = [];

                $.get( 'fontend/getModeData.php?mode=' + modeCode, function( result ) {
                    // result = JSON.parse( result );

                    if( result.errno == 0 ) {
                        var tpl = '<option value="{1}">{0}</option>';

                        window.modeList = [];

                        $.each( result.data, function( i, item ) {
                            window.modeList.push( JC.f.printf( tpl, item.name, item.value ) );
                        } );
                    } else {
                        alert( result.errmsg );
                    }
                } );

                jsPlumbToolkit.Dialogs.show({
                    id: 'fc-edge-form',
                    title: '条件分支设置',
                    data: data,
                    onOK: function (d) {
                        d.conditionList = conditionList;

                        callback( d );
                    },
                    onMaybeClose: function() {
                        var viewBlock = $( '#expView' ),
                            conditionData,
                            type;

                        $.each( viewBlock.find( 'div.expBlock' ), function( i, item ) {
                            item = $( item );
                            type = item.attr( 'block-type' );

                            if( type == 'condition' ) {
                                conditionData = {
                                    modeData: item.find( '.js_modeDataSel' ).val(),
                                    modeSbl: item.find( '.js_modeSbl' ).val(),
                                    modeCnt: item.find( '.js_ctnView' ).find( '*' ).first().val()
                                };
                            } else {
                                conditionData = {
                                    symbol: item.find( '.js_symbolSel' ).val()
                                }
                            }

                            conditionList.push( {
                                type: type,
                                data: conditionData
                            } );
                        } );

                        return JC.Valid.check( $( '.jtk-dialog-overlay form' ) );
                    }
                });

                if( data.conditionList ) {
                    var expBlock = $( '#expView' ),
                        conditionTpl = $( '#addCondition' ).html(),
                        symbolTpl = $( '#addSymbol' ).html(),
                        $condition, $symbol, ctnTpl;

                    $.each( data.conditionList, function( i, item ){
                        if( item.type == 'condition' ) {
                            expBlock.append( '<span sort-no='+ i +'></span>' )
                            $.get( 'fontend/getFileCnt.php?data=' + item.data.modeData, function( result ) {
                                // result = JSON.parse( result );

                                if( result.errno == 0 ) {
                                    var rData = result.data;
                                    if( rData.type == 0 ) {//input
                                        ctnTpl = '<input style="width: 35%;" reqmsg="请填写数据" value="{0}"/>';

                                        ctnTpl = JC.f.printf( ctnTpl, item.data.modeCnt );
                                    } else {//select
                                        var list = [],
                                            optionTpl = '<option value="{1}" {2}>{0}</option>';

                                        $.each( rData.data, function( i, sitem ) {
                                            list.push( JC.f.printf( optionTpl, sitem.name, sitem.value, sitem.value == item.data.modeCnt ? 'selected' : '' ) );
                                        } );

                                        ctnTpl = '<select class="js_modeCntSel" style="width: 35%;" subdatatype="ucheck" ucheckCallback="selectCheck" ucheckmsg="请选择数据" emel="(table .errmsg"><option value="-1">请选择</option>{0}</select>';

                                        ctnTpl = JC.f.printf( ctnTpl, list.join( '' ) );
                                    }
                                } else {
                                    alert( result.errmsg );
                                }

                                $condition = $( JC.f.printf( conditionTpl, window.modeList.join( '' ), ctnTpl ).replace( /[\s]{2,}/g, '' ) );

                                $condition.find( '.js_modeDataSel option[ value='+ item.data.modeData +' ]' ).attr( 'selected', true );

                                $condition.find( '.js_modeSbl option[ value='+ item.data.modeSbl +' ]' ).attr( 'selected', true );

                                $condition.find( '.js_modeCntSel option[ value='+ item.data.modeCnt +' ]' ).attr( 'selected', true );

                                expBlock.find( 'span[ sort-no=' + i + ' ]' ).replaceWith( $condition );
                            } );
                        } else {
                            $symbol = $( symbolTpl.replace( /[\s]{2,}/g, '' ) );

                            $symbol.find( '.js_symbolSel option[ value='+ item.data.symbol +' ]' ).attr( 'selected', true );

                            expBlock.append( $symbol );
                        }
                    });
                }
            }

            function conditionFilter( _tpl ) {
                return JC.f.printf( _tpl, window.modeList.join( '' ), '' );
            }

            function togetherFilter( _tpl ) {
                var list = [],
                    optionTpl = '<option value="{1}">{0}</option>';

                $.each( window.linkEdgeList, function( i, item ) {
                    list.push( JC.f.printf( optionTpl, item.label, item.id ) );
                } );

                return JC.f.printf( _tpl, list.join( '' ) );
            }

            function selectCheck( _item ) {
                var _r = false, 
                    _v = JC.f.parseFinance( _item.val() );

                if( _v >= 0 ) {
                   _r = true;
                }
                return _r;
            }

        </script>
    </body>
</html>

